---
tags:
  - "#networking/protocols"
  - "#cybersecurity/red-team/recon"
  - "#interview/concepts"
aliases:
  - Internet Control Message Protocol
---

# ICMP

> **One-liner:** A network layer protocol used for error reporting and diagnostic functions like [[Ping]] and [[Traceroute]].

## ğŸ¯ What Is It?
Internet Control Message Protocol (ICMP) is a supporting protocol in the Internet Protocol suite used by network devices to send error messages and operational information. Unlike TCP/UDP, ICMP is not used for data exchange but for network diagnostics and control.

ICMP operates at Layer 3 (Network Layer) of the OSI model and is encapsulated directly within IP packets.

## ğŸ¤” Why It Matters
- **Network Diagnostics:** Powers essential tools like [[Ping]] and [[Traceroute]]
- **Error Reporting:** Informs senders when packets can't be delivered
- **Security Implications:** Can be abused for reconnaissance, covert channels, and DoS attacks
- **Firewall Considerations:** Often filtered, affecting legitimate troubleshooting

## ğŸ”¬ How It Works

### Core Principles
1. ICMP messages are encapsulated in IP packets (Protocol number 1)
2. Each message has a Type and Code field defining its purpose
3. No port numbersâ€”ICMP is identified by protocol field only
4. Typically generated by routers, firewalls, or destination hosts

### ICMP Header Structure
| Field | Size | Description |
|-------|------|-------------|
| Type | 1 byte | Category of message |
| Code | 1 byte | Specific condition within type |
| Checksum | 2 bytes | Error detection |
| Message Body | Variable | Type-specific data |
| **Total Header** | **8 bytes minimum** | |

## ğŸ“Š Common ICMP Types

| Type | Code | Name | Used By |
|------|------|------|---------|
| 0 | 0 | Echo Reply | [[Ping]] response |
| 3 | 0-15 | Destination Unreachable | Routers, firewalls |
| 3 | 1 | Host Unreachable | Router can't reach host |
| 3 | 3 | Port Unreachable | No service on port |
| 5 | 0-3 | Redirect | Router path optimization |
| 8 | 0 | Echo Request | [[Ping]] command |
| 11 | 0 | Time Exceeded (TTL) | [[Traceroute]] |

## ğŸ›¡ï¸ Detection & Prevention

### Security Concerns
- **ICMP Tunneling:** Exfiltrating data hidden in ICMP payloads
- **Ping Sweeps:** Mapping live hosts for reconnaissance
- **Smurf Attack:** DDoS using broadcast ICMP
- **Ping of Death:** Oversized ICMP packets causing crashes (historical)

### How to Detect
- Monitor for unusual ICMP payload sizes
- Alert on high-volume ICMP traffic
- Detect ICMP to sequential IPs (sweep detection)
- Inspect ICMP payloads for non-standard data

### How to Prevent / Mitigate
```bash
# Linux: Block all incoming ICMP echo requests
iptables -A INPUT -p icmp --icmp-type echo-request -j DROP

# Rate limit ICMP
iptables -A INPUT -p icmp -m limit --limit 1/s --limit-burst 4 -j ACCEPT
```

## ğŸ¤ Interview Angles

### Common Questions
- "What's the difference between ICMP Type 8 and Type 0?"
  - Type 8 is Echo Request (ping), Type 0 is Echo Reply (pong)
- "Why might you block ICMP on a firewall?"
  - Prevents reconnaissance, but may break legitimate diagnostics
- "What ICMP type does traceroute rely on?"
  - Type 11 (Time Exceeded) when TTL reaches 0

### STAR Story
> **Situation:** SOC alerted on unusual ICMP traffic volume to external IP.
> **Task:** Investigate potential data exfiltration via ICMP tunneling.
> **Action:** Captured packets with Wireshark, analyzed ICMP payloads. Found base64-encoded data in echo request payloadsâ€”confirmed [[ICMP]] tunneling.
> **Result:** Blocked the destination IP, contained compromised host, implemented ICMP payload inspection in IDS.

## âœ… Best Practices
- Allow essential ICMP types (echo, unreachable, time exceeded) but rate-limit
- Inspect ICMP payloads for anomalies in high-security environments
- Don't completely block ICMPâ€”breaks Path MTU Discovery and troubleshooting

## âŒ Common Misconceptions
- "ICMP is just for ping" â€” It handles many error and control messages
- "Blocking ICMP is always good security" â€” Can break legitimate network functions

## ğŸ”— Related Concepts
- [[Ping]]
- [[Traceroute]]
- [[TTL (Time To Live)]]
- [[Domain Name System (DNS)]]
- [[Data Exfiltration]]

## ğŸ“š References
- RFC 792 - Internet Control Message Protocol
- TryHackMe - Active Reconnaissance Room
